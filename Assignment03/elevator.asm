CPU "8085.TBL"
HOF "INT8"

ORG 9000H

; --------------------------------
; 8000H - floor
; 8001H - direction
; 8002H - bitmap
; 8003H - count
; 8004H - flag capacity
; 8005H - capacity
; 800BH - boss
; 800FH - delay flag
; 8006H - ground flag
; 8010-8012H - temporary locations
; --------------------------------

GTHEX: EQU 030EH
HXDSP: EQU 034FH
OUTPUT: EQU 0389H
CLEAR: EQU 02BEH
RDKBD: EQU 03BAH
UPDDT: EQU 044CH
UPDAD: EQU 0440H
ADDR_A: EQU 40H
ADDR_B: EQU 41H
ADDR_C: EQU 42H
ADDR_MODE: EQU 43H

MVI A, 8BH
OUT ADDR_MODE

MVI A, 01H
STA 8000H
MVI A, 0F7H
STA 8002H
MVI A, 00H
STA 8001H
STA 8003H
STA 8004H
STA 800FH
STA 8006H
MVI A, 02H
STA 8005H

CALL INIT

START:
  LOOP1:
    MVI A, 18H
    STA 8011H
    LDA 8012H
    CPI 00H
    JZ ELEVATE
    LDA 8012H
    DCR A
    STA 8012H
    JMP LOOP2

  LOOP2:
    MVI A, 4CH
    STA 8010H
    LDA 8011H
    CPI 00H
    JZ LOOP1
    LDA 8011H
    DCR A
    STA 8011H
    JMP LOOP3

  LOOP3:
    LDA 8010H
    CPI 00H
    JZ LOOP2
    LDA 8010H
    DCR A
    STA 8010H
    JMP LOOP3

  ELEVATE:
    LDA 8001H
    CPI 00H
    JZ INCREMENT
    LDA 8001H
    CPI 01H
    JZ DECREMENT
    JMP INCREMENT_BOSS


  INCREMENT:
    MVI A, 00H
    STA 8006H
    LDA 800BH
    MOV B, A
    IN ADDR_B
    ANA B
    CPI 00H
    JNZ INCREMENT_BOSS

    MVI A, 00H
    STA 8001H
    LDA 8002H
    MOV B, A
   	LDA 8000H
    CPI 80H
    JZ DECREMENT
    CMA
    ANA B
    STA 8002H
    IN ADDR_B
    MOV B, A
    LDA 8002H
    ANA B
    JZ DECREMENT
    LDA 8000H
    RLC
    STA 8000H
    CALL INIT
    JMP LOOP1


INIT:
  MVI A, 4CH
  STA 8010H
  MVI A, 18H
  STA 8011H
  STA 8012H
  CALL DISPLAY
  RET

DECREMENT:
MVI A, 00H
    STA 8006H
  MVI A, 01H
  STA 8001H
  LDA 8002H
  MOV B, A
  LDA 8000H
  CPI 01H
  JZ HOLD
  JC HOLD
  ORA B
  STA 8002H
  LDA 8003H
  MOV B, A
  LDA 8005H
  CMP B
  JZ DECR_CONT
  JC DECR_CONT
  LDA 8000H
  MOV B, A
  IN ADDR_B
  ANA B
  CZ MARK
  IN ADDR_B
  ANA B
  JNZ LOOP1

DECR_CONT:
  LDA 800FH
  CPI 01H
  JC DELAY
  LDA 8000H
  RRC
  STA 8000H
  MVI A, 00H
  STA 8004H
  STA 800FH
  CALL INIT2
  JMP LOOP1

INIT2:
  MVI A, 00H
  STA 8010H
  MVI A, 00H
  STA 8011H
  STA 8012H
  CALL DISPLAY
  RET

DELAY:
 LDA 800FH
 INR A
 STA 800FH
 CALL INIT
 JMP LOOP1

CHECK_CAPACITY:
  LDA 8005H
  MOV B, A
  LDA 8003H
  CMP B
  CC INCREMENT_COUNT
  RET

INCREMENT_COUNT:
  LDA 8003H
  INR A
  STA 8003H
  RET

MARK:
  LDA 8004H
  CPI 00H
  CZ CHECK_CAPACITY
  MVI A, 01H
  STA 8004H
  RET


DISPLAY:
  LDA 8000H
  OUT ADDR_A 
  RET

HOLD:
  LDA 8006H
  CPI 00H
  CZ DELAY2
  MVI A, 00H
  STA 8003H
  CALL DISPLAY
  MVI A, 01H
  STA 8000H
  MVI A, 0F7H
  STA 8002H
  MVI A, 00H
  STA 8001H
  LDA 800FH
  CMP 00H
  JNZ INCREMENT_BOSS
  IN ADDR_B
  CPI 01H
  JC HOLD
  JZ HOLD
  JMP INCREMENT

  INCREMENT_BOSS:
  MVI A, 00H
    STA 8006H
    LDA 800BH
    MOV B, A
    IN ADDR_B
    ANA B
    CPI 00H
    JZ INCREMENT

    LDA 800BH
    MOV B, A
    LDA 8000H
    CMP B
    JZ DECREMENT

    MVI A, 02H
    STA 8001H
    LDA 8000H
    CMA
    ANA B
    STA 8002H
    LDA 8000H
    CPI 80H
    JZ DECREMENT
    LDA 8000H
    RLC
    STA 8000H
    CALL INIT
    JMP LOOP1

DELAY2:
    MVI A, 01H
    STA 8006H
    MVI C, 2AH
LOOP4:  MVI D, 64H
LOOP5:  MVI E, 0DEH
LOOP6:  DCR E
      JNZ LOOP6
      DCR D
      JNZ LOOP5
      DCR C
      JNZ LOOP4
      RET